name: Node Collector and Testing

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'node_collector.py'
      - 'simple_node_checker.py'
      - '.github/workflows/node_collector.yml'

jobs:
  collect-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp pyyaml requests urllib3 PySocks geoip2

    - name: Create nodes directory
      run: mkdir -p nodes

    - name: Run node collector
      run: |
        echo "ğŸš€ æ£€æŸ¥ node_collector.py æ˜¯å¦å­˜åœ¨..."
        if [ -f "å°ç«ç®­/node_collector.py" ]; then
          echo "âœ… æ‰¾åˆ° å°ç«ç®­/node_collector.py"
          cd å°ç«ç®­
        elif [ -f "node_collector.py" ]; then
          echo "âœ… æ‰¾åˆ°æ ¹ç›®å½• node_collector.py"
        else
          echo "âŒ æœªæ‰¾åˆ° node_collector.py æ–‡ä»¶"
          exit 1
        fi

        # æ£€æŸ¥ simple_node_checker.py æ˜¯å¦å­˜åœ¨
        if [ ! -f "simple_node_checker.py" ]; then
          echo "âš ï¸ ç¼ºå°‘ simple_node_checker.pyï¼Œåˆ›å»ºåŸºç¡€ç‰ˆæœ¬..."
          echo "" > simple_node_checker.py
        fi

        # æ£€æŸ¥ china_node_tester.py æ˜¯å¦å­˜åœ¨
        if [ ! -f "china_node_tester.py" ]; then
          echo "âš ï¸ ç¼ºå°‘ china_node_tester.pyï¼Œåˆ›å»ºåŸºç¡€ç‰ˆæœ¬..."
          echo "" > china_node_tester.py
        fi

        echo "ğŸš€ å¼€å§‹è¿è¡ŒèŠ‚ç‚¹æ”¶é›†å™¨..."
        python node_collector.py

    - name: Check generated files
      run: |
        ls -la å°ç«ç®­/nodes/ 2>/dev/null || ls -la nodes/ 2>/dev/null || echo "No nodes directory found"

    - name: Move files to root nodes directory
      run: |
        if [ -d "å°ç«ç®­/nodes" ]; then
          cp -r å°ç«ç®­/nodes/* nodes/ 2>/dev/null || echo "No files to copy from å°ç«ç®­/nodes"
        fi
        if [ -d "nodes" ] && [ "$(ls -A nodes 2>/dev/null)" ]; then
          echo "Files already in nodes directory"
        else
          echo "No valid nodes directory found"
        fi

    - name: Generate README for nodes
      run: |
        cat > nodes/README.md << 'EOF'


    - name: Update node counts in README
      run: |
        V2RAY_COUNT=$(wc -l < nodes/v2ray.txt 2>/dev/null || echo 0)
        SS_COUNT=$(wc -l < nodes/shadowsocks.txt 2>/dev/null || echo 0)
        TROJAN_COUNT=$(wc -l < nodes/trojan.txt 2>/dev/null || echo 0)
        CLASH_COUNT=$(grep -c "name:" nodes/clash.yaml 2>/dev/null || echo 0)
        TOTAL_COUNT=$((V2RAY_COUNT + SS_COUNT + TROJAN_COUNT))
        sed -i "s/- ğŸ”„ \*\*æ›´æ–°æ—¶é—´\*\*:.*/- ğŸ”„ **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')/" nodes/README.md
        sed -i "/## ğŸ“Š èŠ‚ç‚¹ç»Ÿè®¡/a\\- ğŸ“ˆ **æ€»èŠ‚ç‚¹æ•°**: $TOTAL_COUNT\\n- ğŸ¯ **V2RayèŠ‚ç‚¹**: $V2RAY_COUNT\\n- ğŸ›¡ï¸ **ShadowsocksèŠ‚ç‚¹**: $SS_COUNT\\n- ğŸ” **TrojanèŠ‚ç‚¹**: $TROJAN_COUNT\\n- âš¡ **Clashé…ç½®**: $CLASH_COUNT ä¸ªä»£ç†" nodes/README.md

- name: Create release on significant updates
  if: github.event_name == 'schedule'
  run: |
    TOTAL_NODES=0
    [ -f "nodes/v2ray.txt" ] && TOTAL_NODES=$((TOTAL_NODES + $(wc -l < nodes/v2ray.txt)))
    [ -f "nodes/shadowsocks.txt" ] && TOTAL_NODES=$((TOTAL_NODES + $(wc -l < nodes/shadowsocks.txt)))
    [ -f "nodes/trojan.txt" ] && TOTAL_NODES=$((TOTAL_NODES + $(wc -l < nodes/trojan.txt)))
    if [ $TOTAL_NODES -gt 50 ]; then
      RELEASE_TAG="nodes-$(date '+%Y%m%d-%H%M')"
      RELEASE_TITLE="ğŸš€ èŠ‚ç‚¹æ›´æ–° $(date '+%Y-%m-%d %H:%M')"
      cat > release_notes.md << 'EOF'
## ğŸ“Š æœ¬æ¬¡æ›´æ–°ç»Ÿè®¡

- ğŸ¯ **æ€»èŠ‚ç‚¹æ•°**: PLACEHOLDER
- ğŸ”„ **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
- âœ… **æµ‹æ´»çŠ¶æ€**: å·²é€šè¿‡è¿é€šæ€§æµ‹è¯•

## ğŸ“‹ è®¢é˜…é“¾æ¥

- V2Ray: https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/v2ray.txt
- Clash: https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/clash.yaml
- Shadowsocks: https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/shadowsocks.txt
- Trojan: https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/trojan.txt
EOF

      gh release create "$RELEASE_TAG" --title "$RELEASE_TITLE" --notes-file release_notes.md nodes/*.txt nodes/*.yaml || echo "Release creation failed, continuing..."
    fi
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
