name: Node Collector and Testing

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'node_collector.py'
      - 'simple_node_checker.py'
      - '.github/workflows/node_collector.yml'

jobs:
  collect-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp pyyaml requests urllib3 PySocks
        
    - name: Create nodes directory
      run: |
        mkdir -p nodes
        
    - name: Run node collector
      run: |
        cd å°ç«ç®­
        python node_collector.py
        
    - name: Check generated files
      run: |
        ls -la å°ç«ç®­/nodes/ || echo "No nodes directory found"
        
    - name: Move files to root nodes directory
      run: |
        if [ -d "å°ç«ç®­/nodes" ]; then
          cp -r å°ç«ç®­/nodes/* nodes/ 2>/dev/null || echo "No files to copy"
        fi
        
    - name: Generate README for nodes
      run: |
        cat > nodes/README.md << 'EOF'
        # å…è´¹ä»£ç†èŠ‚ç‚¹

        [![Update Status](https://github.com/${{ github.repository }}/workflows/Node%20Collector%20and%20Testing/badge.svg)](https://github.com/${{ github.repository }}/actions)
        [![Telegram](https://img.shields.io/badge/ðŸ“±_TGé¢‘é“-2CA5E0?style=for-the-badge&logo=telegram&logoColor=white)](https://t.me/fq521)

        ## ðŸ“Š èŠ‚ç‚¹ç»Ÿè®¡

        - ðŸ”„ **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - ðŸŒ **æ•°æ®æ¥æº**: 60+ å…è´¹èŠ‚ç‚¹è®¢é˜…æº
        - âœ… **æµ‹æ´»æ£€æµ‹**: è‡ªåŠ¨ç­›é€‰å¯ç”¨èŠ‚ç‚¹
        - ðŸš€ **æ›´æ–°é¢‘çŽ‡**: æ¯6å°æ—¶è‡ªåŠ¨æ›´æ–°

        ## ðŸ“‹ è®¢é˜…é“¾æŽ¥

        ### V2Ray è®¢é˜…
        ```
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/v2ray.txt
        ```

        ### Clash è®¢é˜…
        ```
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/clash.yaml
        ```

        ### Shadowsocks è®¢é˜…
        ```
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/shadowsocks.txt
        ```

        ### Trojan è®¢é˜…
        ```
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/trojan.txt
        ```

        ## ðŸ“± ä½¿ç”¨æ–¹æ³•

        ### V2Ray/V2RayN
        1. å¤åˆ¶V2Rayè®¢é˜…é“¾æŽ¥
        2. åœ¨å®¢æˆ·ç«¯ä¸­æ·»åŠ è®¢é˜…
        3. æ›´æ–°è®¢é˜…å³å¯ä½¿ç”¨

        ### Clash/ClashX
        1. å¤åˆ¶Clashè®¢é˜…é“¾æŽ¥
        2. åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ è®¢é˜…
        3. æ›´æ–°é…ç½®å³å¯ä½¿ç”¨

        ### Shadowrocket
        1. å¤åˆ¶å¯¹åº”åè®®çš„è®¢é˜…é“¾æŽ¥
        2. åœ¨åº”ç”¨ä¸­æ·»åŠ èŠ‚ç‚¹
        3. è¿žæŽ¥ä½¿ç”¨

        ## âš ï¸ å…è´£å£°æ˜Ž

        - æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨
        - è¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„
        - ä¸å¾—ç”¨äºŽéžæ³•ç”¨é€”
        - ä½¿ç”¨æœ¬æœåŠ¡å³è¡¨ç¤ºåŒæ„æ‰¿æ‹…ç›¸åº”é£Žé™©

        ## ðŸ”— ç›¸å…³é“¾æŽ¥

        - [Telegramé¢‘é“](https://t.me/fq521) - èŽ·å–æœ€æ–°èŠ‚ç‚¹ä¿¡æ¯
        - [é¡¹ç›®ä¸»é¡µ](https://github.com/${{ github.repository }}) - æŸ¥çœ‹æºä»£ç 
        - [Issues](https://github.com/${{ github.repository }}/issues) - åé¦ˆé—®é¢˜

        ---
        
        **â­ å¦‚æžœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªStaræ”¯æŒä¸€ä¸‹ï¼**
        EOF
        
    - name: Update node counts in README
      run: |
        if [ -f "nodes/v2ray.txt" ]; then
          V2RAY_COUNT=$(wc -l < nodes/v2ray.txt)
        else
          V2RAY_COUNT=0
        fi
        
        if [ -f "nodes/shadowsocks.txt" ]; then
          SS_COUNT=$(wc -l < nodes/shadowsocks.txt)
        else
          SS_COUNT=0
        fi
        
        if [ -f "nodes/trojan.txt" ]; then
          TROJAN_COUNT=$(wc -l < nodes/trojan.txt)
        else
          TROJAN_COUNT=0
        fi
        
        if [ -f "nodes/clash.yaml" ]; then
          CLASH_COUNT=$(grep -c "name:" nodes/clash.yaml || echo "0")
        else
          CLASH_COUNT=0
        fi
        
        TOTAL_COUNT=$((V2RAY_COUNT + SS_COUNT + TROJAN_COUNT))
        
        # æ›´æ–°READMEä¸­çš„ç»Ÿè®¡ä¿¡æ¯
        sed -i "s/- ðŸ”„ \*\*æ›´æ–°æ—¶é—´\*\*:.*/- ðŸ”„ **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')/" nodes/README.md
        sed -i "/## ðŸ“Š èŠ‚ç‚¹ç»Ÿè®¡/a\\- ðŸ“ˆ **æ€»èŠ‚ç‚¹æ•°**: $TOTAL_COUNT\\n- ðŸŽ¯ **V2RayèŠ‚ç‚¹**: $V2RAY_COUNT\\n- ðŸ›¡ï¸ **ShadowsocksèŠ‚ç‚¹**: $SS_COUNT\\n- ðŸ” **TrojanèŠ‚ç‚¹**: $TROJAN_COUNT\\n- âš¡ **Clashé…ç½®**: $CLASH_COUNT ä¸ªä»£ç†" nodes/README.md
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add nodes/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        # æäº¤æ›´æ”¹
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
        git commit -m "ðŸš€ è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹ - $TIMESTAMP

        ðŸ“Š æœ¬æ¬¡æ›´æ–°ç»Ÿè®¡:
        $(if [ -f "nodes/v2ray.txt" ]; then echo "- V2Ray: $(wc -l < nodes/v2ray.txt) ä¸ªèŠ‚ç‚¹"; fi)
        $(if [ -f "nodes/shadowsocks.txt" ]; then echo "- Shadowsocks: $(wc -l < nodes/shadowsocks.txt) ä¸ªèŠ‚ç‚¹"; fi)
        $(if [ -f "nodes/trojan.txt" ]; then echo "- Trojan: $(wc -l < nodes/trojan.txt) ä¸ªèŠ‚ç‚¹"; fi)
        $(if [ -f "nodes/clash.yaml" ]; then echo "- Clash: $(grep -c 'name:' nodes/clash.yaml || echo '0') ä¸ªä»£ç†"; fi)
        
        ðŸ”„ æ•°æ®æ¥æº: 60+ å…è´¹èŠ‚ç‚¹è®¢é˜…æº
        âœ… æµ‹æ´»çŠ¶æ€: å·²é€šè¿‡è¿žé€šæ€§æµ‹è¯•
        ðŸ“± TGé¢‘é“: https://t.me/fq521"
        
        # æŽ¨é€æ›´æ”¹
        git push
        
    - name: Create release on significant updates
      if: github.event_name == 'schedule'
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„èŠ‚ç‚¹åˆ›å»ºrelease
        TOTAL_NODES=0
        if [ -f "nodes/v2ray.txt" ]; then
          TOTAL_NODES=$((TOTAL_NODES + $(wc -l < nodes/v2ray.txt)))
        fi
        if [ -f "nodes/shadowsocks.txt" ]; then
          TOTAL_NODES=$((TOTAL_NODES + $(wc -l < nodes/shadowsocks.txt)))
        fi
        if [ -f "nodes/trojan.txt" ]; then
          TOTAL_NODES=$((TOTAL_NODES + $(wc -l < nodes/trojan.txt)))
        fi
        
        if [ $TOTAL_NODES -gt 50 ]; then
          RELEASE_TAG="nodes-$(date '+%Y%m%d-%H%M')"
          RELEASE_TITLE="ðŸš€ èŠ‚ç‚¹æ›´æ–° $(date '+%Y-%m-%d %H:%M')"
          
          # åˆ›å»ºreleaseè¯´æ˜Ž
          cat > release_notes.md << EOF
        ## ðŸ“Š æœ¬æ¬¡æ›´æ–°ç»Ÿè®¡
        
        - ðŸŽ¯ **æ€»èŠ‚ç‚¹æ•°**: $TOTAL_NODES
        - ðŸ”„ **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - âœ… **æµ‹æ´»çŠ¶æ€**: å·²é€šè¿‡è¿žé€šæ€§æµ‹è¯•
        
        ## ðŸ“‹ è®¢é˜…é“¾æŽ¥
        
        ### V2Ray è®¢é˜…
        \`\`\`
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/v2ray.txt
        \`\`\`
        
        ### Clash è®¢é˜…
        \`\`\`
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/clash.yaml
        \`\`\`
        
        ### Shadowsocks è®¢é˜…
        \`\`\`
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/shadowsocks.txt
        \`\`\`
        
        ### Trojan è®¢é˜…
        \`\`\`
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/trojan.txt
        \`\`\`
        
        ## ðŸ“± èŽ·å–æ›´å¤š
        
        - [Telegramé¢‘é“](https://t.me/fq521) - å®žæ—¶èŠ‚ç‚¹æ›´æ–°
        - [é¡¹ç›®ä¸»é¡µ](https://github.com/${{ github.repository }}) - æŸ¥çœ‹æºä»£ç 
        
        ---
        **âš ï¸ ä»…ä¾›å­¦ä¹ ç ”ç©¶ä½¿ç”¨ï¼Œè¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„**
        EOF
          
          # ä½¿ç”¨GitHub CLIåˆ›å»ºrelease
          gh release create "$RELEASE_TAG" \
            --title "$RELEASE_TITLE" \
            --notes-file release_notes.md \
            nodes/*.txt nodes/*.yaml || echo "Release creation failed, continuing..."
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Clean up old releases
      if: github.event_name == 'schedule'
      run: |
        # ä¿ç•™æœ€æ–°çš„5ä¸ªreleaseï¼Œåˆ é™¤æ—§çš„
        gh release list --limit 100 --json tagName,createdAt | \
        jq -r 'sort_by(.createdAt) | reverse | .[5:] | .[].tagName' | \
        while read tag; do
          echo "Deleting old release: $tag"
          gh release delete "$tag" --yes || echo "Failed to delete $tag"
        done
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
