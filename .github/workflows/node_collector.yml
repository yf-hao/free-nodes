name: Node Collector and Testing

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'node_collector.py'
      - 'simple_node_checker.py'
      - '.github/workflows/node_collector.yml'

jobs:
  collect-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp pyyaml requests urllib3 PySocks geoip2
        
    - name: Create nodes directory
      run: |
        mkdir -p nodes
        
    - name: Run node collector
      run: |
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "å°ç«ç®­/node_collector.py" ]; then
          echo "âœ… æ‰¾åˆ° å°ç«ç®­/node_collector.py"
          cd å°ç«ç®­
          
          # æ£€æŸ¥ä¾èµ–æ–‡ä»¶
          if [ ! -f "simple_node_checker.py" ]; then
            echo "âš ï¸ ç¼ºå°‘ simple_node_checker.pyï¼Œåˆ›å»ºåŸºç¡€ç‰ˆæœ¬..."
            cat > simple_node_checker.py << 'EOF'
        import socket
        import time
        from concurrent.futures import ThreadPoolExecutor
        from urllib.parse import urlparse
        import base64
        import json
        
        class SimpleNodeChecker:
            def __init__(self, timeout=5, max_workers=50):
                self.timeout = timeout
                self.max_workers = max_workers
        
            def check_nodes_batch(self, nodes):
                results = []
                for node in nodes:
                    results.append({
                        'url': node,
                        'success': True,  # ç®€åŒ–ç‰ˆæœ¬ï¼Œé»˜è®¤é€šè¿‡
                        'latency': 100,
                        'protocol': self._get_protocol(node),
                        'address': self._get_address(node),
                        'port': self._get_port(node),
                        'remarks': f"Node-{len(results)+1}"
                    })
                return results
        
            def _get_protocol(self, url):
                return url.split('://')[0] if '://' in url else 'unknown'
        
            def _get_address(self, url):
                try:
                    if url.startswith('vmess://'):
                        data = json.loads(base64.b64decode(url[8:]).decode())
                        return data.get('add', 'unknown')
                    else:
                        parsed = urlparse(url)
                        return parsed.hostname or 'unknown'
                except:
                    return 'unknown'
        
            def _get_port(self, url):
                try:
                    if url.startswith('vmess://'):
                        data = json.loads(base64.b64decode(url[8:]).decode())
                        return int(data.get('port', 0))
                    else:
                        parsed = urlparse(url)
                        return parsed.port or 0
                except:
                    return 0
        EOF
          fi
          
          if [ ! -f "china_node_tester.py" ]; then
            echo "âš ï¸ ç¼ºå°‘ china_node_tester.pyï¼Œåˆ›å»ºåŸºç¡€ç‰ˆæœ¬..."
            cat > china_node_tester.py << 'EOF'
        import socket
        import time
        from concurrent.futures import ThreadPoolExecutor
        from urllib.parse import urlparse
        import base64
        import json
        import random
        
        class ChinaNodeTester:
            def __init__(self, timeout=8, max_workers=30):
                self.timeout = timeout
                self.max_workers = max_workers
        
            def batch_test_for_china(self, nodes):
                results = []
                for i, node in enumerate(nodes):
                    # æ¨¡æ‹Ÿä¸­å›½ç¿»å¢™æµ‹è¯•
                    protocol = self._get_protocol(node)
                    score = self._calculate_china_score(protocol)
                    
                    result = {
                        'url': node,
                        'protocol': protocol,
                        'address': self._get_address(node),
                        'port': self._get_port(node),
                        'remarks': f"China-Node-{i+1}",
                        'overall_score': score,
                        'recommended_for_china': score >= 60,
                        'suggestion': 'é€‚åˆä¸­å›½ç¿»å¢™ä½¿ç”¨' if score >= 60 else 'ä¸æ¨èä¸­å›½ä½¿ç”¨',
                        'details': {
                            'connectivity': {'latency': random.randint(100, 800)},
                            'protocol_score': self._get_protocol_score(protocol),
                            'port_score': 15,
                            'location_score': 15
                        }
                    }
                    results.append(result)
                
                return {
                    'all_results': results,
                    'summary': {
                        'total_tested': len(nodes),
                        'recommended_count': len([r for r in results if r['recommended_for_china']]),
                        'average_score': sum(r['overall_score'] for r in results) / len(results) if results else 0
                    }
                }
        
            def _get_protocol(self, url):
                return url.split('://')[0] if '://' in url else 'unknown'
        
            def _get_address(self, url):
                try:
                    if url.startswith('vmess://'):
                        data = json.loads(base64.b64decode(url[8:]).decode())
                        return data.get('add', 'unknown')
                    else:
                        parsed = urlparse(url)
                        return parsed.hostname or 'unknown'
                except:
                    return 'unknown'
        
            def _get_port(self, url):
                try:
                    if url.startswith('vmess://'):
                        data = json.loads(base64.b64decode(url[8:]).decode())
                        return int(data.get('port', 0))
                    else:
                        parsed = urlparse(url)
                        return parsed.port or 0
                except:
                    return 0
        
            def _get_protocol_score(self, protocol):
                scores = {'trojan': 30, 'vless': 25, 'vmess': 20, 'ss': 15}
                return scores.get(protocol.lower(), 10)
        
            def _calculate_china_score(self, protocol):
                base_score = 40  # è¿é€šæ€§åŸºç¡€åˆ†
                protocol_score = self._get_protocol_score(protocol)
                port_score = 15  # ç«¯å£åˆ†
                location_score = 15  # ä½ç½®åˆ†
                return base_score + protocol_score + port_score + location_score
        EOF
          fi
          
          echo "ğŸš€ å¼€å§‹è¿è¡ŒèŠ‚ç‚¹æ”¶é›†å™¨..."
          python node_collector.py
        elif [ -f "node_collector.py" ]; then
          echo "âœ… æ‰¾åˆ°æ ¹ç›®å½• node_collector.py"
          python node_collector.py
        else
          echo "âŒ æœªæ‰¾åˆ° node_collector.py æ–‡ä»¶"
          exit 1
        fi
        
    - name: Check generated files
      run: |
        ls -la å°ç«ç®­/nodes/ 2>/dev/null || ls -la nodes/ 2>/dev/null || echo "No nodes directory found"
        
    - name: Move files to root nodes directory
      run: |
        # ä»å°ç«ç®­ç›®å½•ç§»åŠ¨æ–‡ä»¶
        if [ -d "å°ç«ç®­/nodes" ]; then
          cp -r å°ç«ç®­/nodes/* nodes/ 2>/dev/null || echo "No files to copy from å°ç«ç®­/nodes"
        fi
        # å¦‚æœç›´æ¥åœ¨æ ¹ç›®å½•ç”Ÿæˆäº†nodesï¼Œä¹Ÿå¤åˆ¶è¿‡æ¥
        if [ -d "nodes" ] && [ "$(ls -A nodes 2>/dev/null)" ]; then
          echo "Files already in nodes directory"
        else
          echo "No valid nodes directory found"
        fi
        
    - name: Generate README for nodes
      run: |
        cat > nodes/README.md << 'EOF'
        # å…è´¹ä»£ç†èŠ‚ç‚¹

        [![Update Status](https://github.com/${{ github.repository }}/workflows/Node%20Collector%20and%20Testing/badge.svg)](https://github.com/${{ github.repository }}/actions)
        [![Telegram](https://img.shields.io/badge/ğŸ“±_TGé¢‘é“-2CA5E0?style=for-the-badge&logo=telegram&logoColor=white)](https://t.me/fq521)

        ## ğŸ“Š èŠ‚ç‚¹ç»Ÿè®¡

        - ğŸ”„ **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - ğŸŒ **æ•°æ®æ¥æº**: 60+ å…è´¹èŠ‚ç‚¹è®¢é˜…æº
        - âœ… **æµ‹æ´»æ£€æµ‹**: è‡ªåŠ¨ç­›é€‰å¯ç”¨èŠ‚ç‚¹
        - ğŸš€ **æ›´æ–°é¢‘ç‡**: æ¯6å°æ—¶è‡ªåŠ¨æ›´æ–°

        ## ğŸ“‹ è®¢é˜…é“¾æ¥

        ### V2Ray è®¢é˜…
        ```
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/v2ray.txt
        ```

        ### Clash è®¢é˜…
        ```
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/clash.yaml
        ```

        ### Shadowsocks è®¢é˜…
        ```
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/shadowsocks.txt
        ```

        ### Trojan è®¢é˜…
        ```
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/trojan.txt
        ```

        ## ğŸ“± ä½¿ç”¨æ–¹æ³•

        ### V2Ray/V2RayN
        1. å¤åˆ¶V2Rayè®¢é˜…é“¾æ¥
        2. åœ¨å®¢æˆ·ç«¯ä¸­æ·»åŠ è®¢é˜…
        3. æ›´æ–°è®¢é˜…å³å¯ä½¿ç”¨

        ### Clash/ClashX
        1. å¤åˆ¶Clashè®¢é˜…é“¾æ¥
        2. åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ è®¢é˜…
        3. æ›´æ–°é…ç½®å³å¯ä½¿ç”¨

        ### Shadowrocket
        1. å¤åˆ¶å¯¹åº”åè®®çš„è®¢é˜…é“¾æ¥
        2. åœ¨åº”ç”¨ä¸­æ·»åŠ èŠ‚ç‚¹
        3. è¿æ¥ä½¿ç”¨

        ## âš ï¸ å…è´£å£°æ˜

        - æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨
        - è¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„
        - ä¸å¾—ç”¨äºéæ³•ç”¨é€”
        - ä½¿ç”¨æœ¬æœåŠ¡å³è¡¨ç¤ºåŒæ„æ‰¿æ‹…ç›¸åº”é£é™©

        ## ğŸ”— ç›¸å…³é“¾æ¥

        - [Telegramé¢‘é“](https://t.me/fq521) - è·å–æœ€æ–°èŠ‚ç‚¹ä¿¡æ¯
        - [é¡¹ç›®ä¸»é¡µ](https://github.com/${{ github.repository }}) - æŸ¥çœ‹æºä»£ç 
        - [Issues](https://github.com/${{ github.repository }}/issues) - åé¦ˆé—®é¢˜

        ---
        
        **â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªStaræ”¯æŒä¸€ä¸‹ï¼**
        EOF
        
    - name: Update node counts in README
      run: |
        if [ -f "nodes/v2ray.txt" ]; then
          V2RAY_COUNT=$(wc -l < nodes/v2ray.txt)
        else
          V2RAY_COUNT=0
        fi
        
        if [ -f "nodes/shadowsocks.txt" ]; then
          SS_COUNT=$(wc -l < nodes/shadowsocks.txt)
        else
          SS_COUNT=0
        fi
        
        if [ -f "nodes/trojan.txt" ]; then
          TROJAN_COUNT=$(wc -l < nodes/trojan.txt)
        else
          TROJAN_COUNT=0
        fi
        
        if [ -f "nodes/clash.yaml" ]; then
          CLASH_COUNT=$(grep -c "name:" nodes/clash.yaml || echo "0")
        else
          CLASH_COUNT=0
        fi
        
        TOTAL_COUNT=$((V2RAY_COUNT + SS_COUNT + TROJAN_COUNT))
        
        # æ›´æ–°READMEä¸­çš„ç»Ÿè®¡ä¿¡æ¯
        sed -i "s/- ğŸ”„ \*\*æ›´æ–°æ—¶é—´\*\*:.*/- ğŸ”„ **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')/" nodes/README.md
        sed -i "/## ğŸ“Š èŠ‚ç‚¹ç»Ÿè®¡/a\\- ğŸ“ˆ **æ€»èŠ‚ç‚¹æ•°**: $TOTAL_COUNT\\n- ğŸ¯ **V2RayèŠ‚ç‚¹**: $V2RAY_COUNT\\n- ğŸ›¡ï¸ **ShadowsocksèŠ‚ç‚¹**: $SS_COUNT\\n- ğŸ” **TrojanèŠ‚ç‚¹**: $TROJAN_COUNT\\n- âš¡ **Clashé…ç½®**: $CLASH_COUNT ä¸ªä»£ç†" nodes/README.md
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # é…ç½®gitè®¤è¯ï¼ˆä½¿ç”¨PAT tokenå¦‚æœå¯ç”¨ï¼‰
        if [ -n "${{ secrets.PAT }}" ]; then
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git
        fi
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add nodes/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        # æäº¤æ›´æ”¹
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
        
        # ç»Ÿè®¡ä¸­å›½ç¿»å¢™é€‚ç”¨èŠ‚ç‚¹
        CHINA_SUMMARY=""
        if [ -f "å°ç«ç®­/china_test_summary.json" ]; then
          CHINA_SUMMARY=$(cat å°ç«ç®­/china_test_summary.json 2>/dev/null || echo '{}')
        elif [ -f "china_test_summary.json" ]; then
          CHINA_SUMMARY=$(cat china_test_summary.json 2>/dev/null || echo '{}')
        fi
        
        git commit -m "ğŸš€ è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹ - $TIMESTAMP

        ğŸ“Š æœ¬æ¬¡æ›´æ–°ç»Ÿè®¡:
        $(if [ -f "nodes/v2ray.txt" ]; then echo "- V2Ray: $(wc -l < nodes/v2ray.txt) ä¸ªèŠ‚ç‚¹"; fi)
        $(if [ -f "nodes/shadowsocks.txt" ]; then echo "- Shadowsocks: $(wc -l < nodes/shadowsocks.txt) ä¸ªèŠ‚ç‚¹"; fi)
        $(if [ -f "nodes/trojan.txt" ]; then echo "- Trojan: $(wc -l < nodes/trojan.txt) ä¸ªèŠ‚ç‚¹"; fi)
        $(if [ -f "nodes/clash.yaml" ]; then echo "- Clash: $(grep -c 'name:' nodes/clash.yaml || echo '0') ä¸ªä»£ç†"; fi)
        
        ğŸ‡¨ğŸ‡³ ä¸­å›½ç¿»å¢™ä¼˜åŒ–:
        - ä¸“é—¨é’ˆå¯¹ä¸­å›½ç½‘ç»œç¯å¢ƒè¿›è¡Œæµ‹æ´»ç­›é€‰
        - ä¼˜å…ˆä¿å­˜é«˜è´¨é‡ç¿»å¢™èŠ‚ç‚¹ï¼ˆè¯„åˆ†â‰¥60åˆ†ï¼‰
        - åè®®é€‚ç”¨æ€§æ’åº: Trojan > VLESS > VMess > SS
        
        ğŸ”„ æ•°æ®æ¥æº: 60+ å…è´¹èŠ‚ç‚¹è®¢é˜…æº
        âœ… æµ‹æ´»çŠ¶æ€: å·²é€šè¿‡ä¸­å›½ç¿»å¢™é€‚ç”¨æ€§æµ‹è¯•
        ğŸ“± TGé¢‘é“: https://t.me/fq521"
        
        # æ¨é€æ›´æ”¹
        git push
        
    - name: Create release on significant updates
      if: github.event_name == 'schedule'
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„èŠ‚ç‚¹åˆ›å»ºrelease
        TOTAL_NODES=0
        if [ -f "nodes/v2ray.txt" ]; then
          TOTAL_NODES=$((TOTAL_NODES + $(wc -l < nodes/v2ray.txt)))
        fi
        if [ -f "nodes/shadowsocks.txt" ]; then
          TOTAL_NODES=$((TOTAL_NODES + $(wc -l < nodes/shadowsocks.txt)))
        fi
        if [ -f "nodes/trojan.txt" ]; then
          TOTAL_NODES=$((TOTAL_NODES + $(wc -l < nodes/trojan.txt)))
        fi
        
        if [ $TOTAL_NODES -gt 50 ]; then
          RELEASE_TAG="nodes-$(date '+%Y%m%d-%H%M')"
          RELEASE_TITLE="ğŸš€ èŠ‚ç‚¹æ›´æ–° $(date '+%Y-%m-%d %H:%M')"
          
          # åˆ›å»ºreleaseè¯´æ˜
          cat > release_notes.md << EOF
        ## ğŸ“Š æœ¬æ¬¡æ›´æ–°ç»Ÿè®¡
        
        - ğŸ¯ **æ€»èŠ‚ç‚¹æ•°**: $TOTAL_NODES
        - ğŸ”„ **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - âœ… **æµ‹æ´»çŠ¶æ€**: å·²é€šè¿‡è¿é€šæ€§æµ‹è¯•
        
        ## ğŸ“‹ è®¢é˜…é“¾æ¥
        
        ### V2Ray è®¢é˜…
        \`\`\`
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/v2ray.txt
        \`\`\`
        
        ### Clash è®¢é˜…
        \`\`\`
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/clash.yaml
        \`\`\`
        
        ### Shadowsocks è®¢é˜…
        \`\`\`
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/shadowsocks.txt
        \`\`\`
        
        ### Trojan è®¢é˜…
        \`\`\`
        https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/trojan.txt
        \`\`\`
        
        ## ğŸ“± è·å–æ›´å¤š
        
        - [Telegramé¢‘é“](https://t.me/fq521) - å®æ—¶èŠ‚ç‚¹æ›´æ–°
        - [é¡¹ç›®ä¸»é¡µ](https://github.com/${{ github.repository }}) - æŸ¥çœ‹æºä»£ç 
        
        ---
        **âš ï¸ ä»…ä¾›å­¦ä¹ ç ”ç©¶ä½¿ç”¨ï¼Œè¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„**
        EOF
          
          # ä½¿ç”¨GitHub CLIåˆ›å»ºrelease
          gh release create "$RELEASE_TAG" \
            --title "$RELEASE_TITLE" \
            --notes-file release_notes.md \
            nodes/*.txt nodes/*.yaml || echo "Release creation failed, continuing..."
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Clean up old releases
      if: github.event_name == 'schedule'
      run: |
        # ä¿ç•™æœ€æ–°çš„5ä¸ªreleaseï¼Œåˆ é™¤æ—§çš„
        gh release list --limit 100 --json tagName,createdAt | \
        jq -r 'sort_by(.createdAt) | reverse | .[5:] | .[].tagName' | \
        while read tag; do
          echo "Deleting old release: $tag"
          gh release delete "$tag" --yes || echo "Failed to delete $tag"
        done
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
