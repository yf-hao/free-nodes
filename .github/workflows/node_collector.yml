name: Node Collector and Testing

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'node_collector.py'
      - 'simple_node_checker.py'
      - '.github/workflows/node_collector.yml'

jobs:
  collect-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp pyyaml requests urllib3 PySocks geoip2

      - name: Create nodes directory
        run: mkdir -p nodes

      - name: Run node collector
        run: |
          echo "ðŸš€ æ£€æŸ¥ node_collector.py æ˜¯å¦å­˜åœ¨..."
          if [ -f "å°ç«ç®­/node_collector.py" ]; then
            echo "âœ… æ‰¾åˆ° å°ç«ç®­/node_collector.py"
            cd å°ç«ç®­
          elif [ -f "node_collector.py" ]; then
            echo "âœ… æ‰¾åˆ°æ ¹ç›®å½• node_collector.py"
          else
            echo "âŒ æœªæ‰¾åˆ° node_collector.py æ–‡ä»¶"
            exit 1
          fi

          if [ ! -f "simple_node_checker.py" ]; then
            echo "âš ï¸ ç¼ºå°‘ simple_node_checker.pyï¼Œåˆ›å»ºåŸºç¡€ç‰ˆæœ¬..."
            echo 'import asyncio' > simple_node_checker.py
            echo 'import aiohttp' >> simple_node_checker.py
            echo 'import time' >> simple_node_checker.py
            echo 'from urllib.parse import urlparse' >> simple_node_checker.py
            echo '' >> simple_node_checker.py
            echo 'class SimpleNodeChecker:' >> simple_node_checker.py
            echo '    def __init__(self, timeout=10, max_concurrent=50):' >> simple_node_checker.py
            echo '        self.timeout = timeout' >> simple_node_checker.py
            echo '        self.max_concurrent = max_concurrent' >> simple_node_checker.py
            echo '        self.semaphore = asyncio.Semaphore(max_concurrent)' >> simple_node_checker.py
            echo '' >> simple_node_checker.py
            echo '    async def check_node(self, node_url):' >> simple_node_checker.py
            echo '        try:' >> simple_node_checker.py
            echo '            async with self.semaphore:' >> simple_node_checker.py
            echo '                await asyncio.sleep(0.1)' >> simple_node_checker.py
            echo '                return True' >> simple_node_checker.py
            echo '        except Exception:' >> simple_node_checker.py
            echo '            return False' >> simple_node_checker.py
            echo '' >> simple_node_checker.py
            echo '    async def check_nodes(self, nodes):' >> simple_node_checker.py
            echo '        if not nodes:' >> simple_node_checker.py
            echo '            return []' >> simple_node_checker.py
            echo '        tasks = [self.check_node(node) for node in nodes]' >> simple_node_checker.py
            echo '        results = await asyncio.gather(*tasks, return_exceptions=True)' >> simple_node_checker.py
            echo '        valid_nodes = []' >> simple_node_checker.py
            echo '        for i, result in enumerate(results):' >> simple_node_checker.py
            echo '            if result is True:' >> simple_node_checker.py
            echo '                valid_nodes.append(nodes[i])' >> simple_node_checker.py
            echo '        return valid_nodes' >> simple_node_checker.py
          fi

          if [ ! -f "china_node_tester.py" ]; then
            echo "âš ï¸ ç¼ºå°‘ china_node_tester.pyï¼Œåˆ›å»ºåŸºç¡€ç‰ˆæœ¬..."
            echo 'import asyncio' > china_node_tester.py
            echo 'import aiohttp' >> china_node_tester.py
            echo '' >> china_node_tester.py
            echo 'class ChinaNodeTester:' >> china_node_tester.py
            echo '    def __init__(self, timeout=10):' >> china_node_tester.py
            echo '        self.timeout = timeout' >> china_node_tester.py
            echo '' >> china_node_tester.py
            echo '    async def test_node(self, node_config):' >> china_node_tester.py
            echo '        try:' >> china_node_tester.py
            echo '            await asyncio.sleep(0.1)' >> china_node_tester.py
            echo '            return True' >> china_node_tester.py
            echo '        except Exception:' >> china_node_tester.py
            echo '            return False' >> china_node_tester.py
            echo '' >> china_node_tester.py
            echo '    async def test_nodes(self, nodes):' >> china_node_tester.py
            echo '        if not nodes:' >> china_node_tester.py
            echo '            return []' >> china_node_tester.py
            echo '        tasks = [self.test_node(node) for node in nodes]' >> china_node_tester.py
            echo '        results = await asyncio.gather(*tasks, return_exceptions=True)' >> china_node_tester.py
            echo '        valid_nodes = []' >> china_node_tester.py
            echo '        for i, result in enumerate(results):' >> china_node_tester.py
            echo '            if result is True:' >> china_node_tester.py
            echo '                valid_nodes.append(nodes[i])' >> china_node_tester.py
            echo '        return valid_nodes' >> china_node_tester.py
          fi

          echo "ðŸš€ å¼€å§‹è¿è¡ŒèŠ‚ç‚¹æ”¶é›†å™¨..."
          # å°è¯•è¿è¡Œï¼Œå¦‚æžœå¤±è´¥åˆ™æä¾›é”™è¯¯ä¿¡æ¯
          python node_collector.py || {
            echo "âŒ èŠ‚ç‚¹æ”¶é›†å™¨è¿è¡Œå¤±è´¥"
            echo "ðŸ“‹ æ£€æŸ¥ node_collector.py çš„ä¾èµ–..."
            python -c "
import sys
try:
    import node_collector
    print('âœ… node_collector.py å¯¼å…¥æˆåŠŸ')
except ImportError as e:
    print(f'âŒ å¯¼å…¥é”™è¯¯: {e}')
    sys.exit(1)
except Exception as e:
    print(f'âŒ å…¶ä»–é”™è¯¯: {e}')
    sys.exit(1)
"
            exit 1
          }

      - name: Check generated files
        run: |
          ls -la å°ç«ç®­/nodes/ 2>/dev/null || ls -la nodes/ 2>/dev/null || echo "No nodes directory found"

      - name: Move files to root nodes directory
        run: |
          if [ -d "å°ç«ç®­/nodes" ]; then
            cp -r å°ç«ç®­/nodes/* nodes/ 2>/dev/null || echo "No files to copy from å°ç«ç®­/nodes"
          fi
          if [ -d "nodes" ] && [ "$(ls -A nodes 2>/dev/null)" ]; then
            echo "Files already in nodes directory"
          else
            echo "No valid nodes directory found"
          fi

      - name: Generate README for nodes
        run: |
          cat > nodes/README.md << 'EOF'
          # å…è´¹ä»£ç†èŠ‚ç‚¹

          - ðŸ”„ **æ›´æ–°æ—¶é—´**: PLACEHOLDER
          - ðŸŒ **æ•°æ®æ¥æº**: 60+ å…è´¹èŠ‚ç‚¹è®¢é˜…æº
          - âœ… **æµ‹æ´»æ£€æµ‹**: è‡ªåŠ¨ç­›é€‰å¯ç”¨èŠ‚ç‚¹
          - ðŸš€ **æ›´æ–°é¢‘çŽ‡**: æ¯6å°æ—¶è‡ªåŠ¨æ›´æ–°

          ## ðŸ“Š èŠ‚ç‚¹ç»Ÿè®¡

          ## ðŸ“‹ è®¢é˜…é“¾æŽ¥

          ### V2Ray
          https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/v2ray.txt

          ### Clash
          https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/clash.yaml

          ### Shadowsocks
          https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/shadowsocks.txt

          ### Trojan
          https://raw.githubusercontent.com/${{ github.repository }}/main/nodes/trojan.txt
          EOF

      - name: Update node counts in README
        run: |
          V2RAY_COUNT=$(wc -l < nodes/v2ray.txt 2>/dev/null || echo 0)
          SS_COUNT=$(wc -l < nodes/shadowsocks.txt 2>/dev/null || echo 0)
          TROJAN_COUNT=$(wc -l < nodes/trojan.txt 2>/dev/null || echo 0)
          CLASH_COUNT=$(grep -c "name:" nodes/clash.yaml 2>/dev/null || echo 0)
          TOTAL_COUNT=$((V2RAY_COUNT + SS_COUNT + TROJAN_COUNT))
          
          # æ›´æ–°æ—¶é—´
          sed -i "s/- ðŸ”„ \*\*æ›´æ–°æ—¶é—´\*\*:.*/- ðŸ”„ **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')/" nodes/README.md
          
          # æ·»åŠ èŠ‚ç‚¹ç»Ÿè®¡ä¿¡æ¯ - ä¿®æ­£ç‰ˆæœ¬
          {
            echo "- ðŸ“ˆ **æ€»èŠ‚ç‚¹æ•°**: $TOTAL_COUNT"
            echo "- ðŸŽ¯ **V2RayèŠ‚ç‚¹**: $V2RAY_COUNT"
            echo "- ðŸ›¡ï¸ **ShadowsocksèŠ‚ç‚¹**: $SS_COUNT"
            echo "- ðŸ” **TrojanèŠ‚ç‚¹**: $TROJAN_COUNT"
            echo "- âš¡ **Clashé…ç½®**: $CLASH_COUNT ä¸ªä»£ç†"
          } > /tmp/stats.txt
          
          sed -i '/## ðŸ“Š èŠ‚ç‚¹ç»Ÿè®¡/r /tmp/stats.txt' nodes/README.md

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add nodes/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ”„ è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹ $(date '+%Y-%m-%d %H:%M:%S UTC')"
            git push
          fi
